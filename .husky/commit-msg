#!/usr/bin/env bash

HAS_PNPM=true

# è°ƒè¯•ç­‰å¾…
function _wait() {
    echo -e "\033[1;32mæŒ‰ä»»æ„é”®ç»§ç»­~\033[0m"
    read -r -n 1
}

# æ£€æŸ¥æäº¤ä¿¡æ¯è§„èŒƒ
function checkCommitMsg() {
    echo "æ­£åœ¨æ‰§è¡Œæäº¤ä¿¡æ¯æ ¼å¼æ£€æŸ¥, å½“å‰æäº¤ä¿¡æ¯ä¸ºï¼š$(cat "$1")"
    echo -e "\033[1;32mæäº¤è§„èŒƒæ–‡æ¡£è¯·å‚è€ƒï¼šhttps://www.conventionalcommits.org/en/v1.0.0/\033[0m"
    if $HAS_PNPM; then
        pnpm exec commitlint --edit "$1"
    else
        npx --no-install commitlint --edit "$1"
    fi
}

# æ ¼å¼åŒ–è„šæœ¬
function formatCode() {
    echo "æ­£åœ¨æ‰§è¡Œæš‚å­˜åŒºæ–‡ä»¶è¯­æ³•æ£€æµ‹ä¸æ ¼å¼å¤„ç†~"
    if $HAS_PNPM; then
        pnpm exec lint-staged
    else
        npx --no-install lint-staged
    fi
}

# Git æš‚å­˜åŒºã€å·¥ä½œåŒºå¤‡ä»½å¤„ç†
function backups() {
    local msg
    msg="åœ¨è¿›è¡Œæäº¤ä¹‹å‰äº $(date +"%Y-%m-%d %H:%M:%S") è¿›è¡Œäº†æ›´æ”¹"
    git stash push -m "$msg"
    git stash apply 0
}

function execute() {
    if ! command pnpm -v pnpm &>/dev/null; then
        HAS_PNPM=false
        echo -e '\033[1;31mè­¦å‘ŠWarnï¼šè¯·ä½¿ç”¨pnpmä½œä¸ºåŒ…ç®¡ç†å·¥å…·ï¼Œå…·ä½“ç‰ˆæœ¬è¯¦æƒ…è¯·æŸ¥é˜…package.jsonæ–‡ä»¶ä¸‹packageManagerå­—æ®µï¼Œå·²é™çº§ä½¿ç”¨NPMï¼\033[0m'
    fi
    # å¤‡ä»½æ“ä½œå…ˆæ‰§è¡Œ
    backups
    checkCommitMsg "$@"
    formatCode "$@"
    # DEBUG on-offğŸ‘‡
    # _wait
}

execute "$@"
